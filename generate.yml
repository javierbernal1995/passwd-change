---
- hosts: all
############################VARIABLES##################################
  vars:
    users:
      - username: "javier"
        groups: "javier"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCtPM9nbCWRvGegWA/gsBvtwa3dCzgBIcE0E9y6PZC6iMHWwDJbf02sjKrH+XtU7v9YOla6DPQG/UkiFPp9z0cZNZ/Nbi/6t1UiQHK/i/OwhIGcHrr4ODVxF1D73mqm9fXIz8lHpA0iIN5jpT28tNVCzG3fL+y0Zk/zUvVqrb01UIfdqCCFQPQaKlB6Aw1Ci4KrRpwJ4vXBB9p3RNZUTsxVBP+lPrlqffQF+AEf7N5c81yhE748gQ5TeRjM4au5fncIIa/38qU5BaYaXO7cspzwmG+EyO8JUE5qqXbBjG7f2QT5PcW5JTuqDiKRvvLeqaQBscZgIYrSV0Ds/0m4qDND javier@Zevenet"

      - username: "adan"
        groups: "adan"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDJNKtgxzn39sOyPwbPN2zHgVmnUOKOJ8k9Qs7Tcd791WIQzt++79egxLRigTqOn5bI1FfZG5zfBcFjJoPFIj0cvyCoCAv2cIT5DA5HjzObI702I2PxMm+56tYRiaXRnFIGlxnMmxY7/0cck1nsCMpTVwNWADjdVv/jPFxdKcp3PCpRti7vm5xV9mNTrMw5TKmS6wA5oLdoVOzNYPhEK1nClch8p8gjTv6bSmVuLpcCRHSiVND14pLgiGNjhxhPRfphrgKZSAtTZOvmzwZL+OGtihjcReozJqSyAEt0wgNHMY1piuxp1JItf8kIbiLVI9PwFgJ4HbhqmXkw5pdO7rat adan@Zevenet"

      - username: "carmen"
        groups: "carmen"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDFTgZ6J8HeOUDP04gUCbOmlQ8yzYcASPXsizjtUsiWSOq9uzxLk9Ix/tA4OU9UWfq4S12Wf1V6WpVcOLvRXcrkQF6kbBbdZq0sRFxwgyyuZKTvu/MEGhO0dAYU+tbur4nv3pQ6mTL5ovGSe3YY5caDlfpqroWkdCfLLlyp+fW8sKAbGycZDwcLTytgDzQYhDriHu797IXRB4/T848HMLjRqiDuXMtF/fleX0nxOIlRsMduHrxDIGrO0W4BMxVsQNHMrpGcRxNlojX7uT9bFvqJzpFBtdiGFVPCvJqhVXDsA5+N1trtRqUJHyv3/FNC41xuIUyJe9a80L0qQ8yalEON carmen@Zevenet"

      - username: "carmen"
        groups: "carmen"
        publica: ""

      - username: "mariano"
        groups: "mariano"
        password: "$6$G.gULXDtEmrwF$xKUgrsr8HfMstO6iQ8Esy6Q5EQaK0JrAyTpg2mmcn5fqwD.8Z.Md4/WjgGG8Yf6iMZBJns66AuqNOCdYc.4h/1"
      - username: "jesus"
        groups: "jesus"
        password: "$6$3brTazJLic6yqJ9T$QJPpL1jGYCpQp1JCYMY4yPhFPcUULqDC8dEOkVYgZdMciZ7zXWVoRjkWqXxNzPFJw0hCq11jGnXDyimMoRbSF/"
    group:
      - group: "mariano"
      - group: "jesus"
  
######################################################################
#Comando para encriptar contraseña mediante consola.
#####apt install whois
##############mkpasswd --method=SHA-512
##############Introducir contraseña y te la cifra. Pegar el chorizo en password=******
#La directiva groups: añade un grupo secundario al usuario. Append lo mete en el grupo aunque el usuario esté creado ya.
  tasks:
##################INSTALACIÓN DE SUDO
  - name: install sudo
    apt: name=sudo update_cache=yes state=latest
#####################CREAR GRUPOS MEDIANTE VARIABLE.###########
######CREA TODOS LOS GRUPOS QUE ESTÁN EN LA VARIABLE GROUP.###################
  - name: create groups 
    group: 
      name: "{{ item.group }}"
    with_items: 
      "{{ group }}"
####################CREA USUARIOS QUE ESTÁN EN LA VARIABLE  USERS CON LOS ATRIBUTOS DE CADA UNO DE LOS USERNAME
#######################VAMOS AÑADIENDO ITEMS POR CADA USUARIO DIFERENTE
#######################REALIZAMOS UN BUCLE QUE VA COGIENDO CADA ATRIBUTO = VALOR QUE HEMOS AÑADIDO
  - name: create users with groups, shell and password.
    user:
      name: "{{ item.username }}"
      group: "{{ item.groups }}"
      password: "{{ item.password }}"
      shell: /bin/bash
      groups: sudo
      append: yes
    with_items:
      "{{ users }}"
############################DIRECTIVAS PARA EL FICHERO ETC/SSH/SSHD_CONFIG
  - name: Disable root login
    lineinfile: dest=/etc/ssh/sshd_config regexp='^PermitRootLogin' line="PermitRootLogin prohibit-password" state=present
  - name: Disable password authentication
    lineinfile: dest=/etc/ssh/sshd_config regexp='^PasswordAuthentication' line="PasswordAuthentication no" state=present
  - name: Enable PAM
    lineinfile: dest=/etc/ssh/sshd_config regexp='^UsePAM' line="UsePAM no" state=present
  - name: Disable challenge response authentication
    lineinfile: dest=/etc/ssh/sshd_config regexp='^ChallengeResponseAuthentication' line="ChallengeResponseAuthentication no" state=present
  - name: Restart SSH service
    service: name=sshd state=restarted
