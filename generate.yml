---
- hosts: all
############################VARIABLES##################################
  vars:
    users:
      - username: "javier"
        groups: "javier"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCjMstMIZV4Cd2NyFz+FYh8lkO/9gTal2GYWv0BeVHqVTlFZc76A6giVhCdJT9awxlw0yZK+oSNJFmVd9GcJktibHWCGsrQd/JVM6DHcG87Jyf5A8fIaaq9QgHIvqsmBUO2KWCHpHLbwbJOm+IXdStwL7+CxLlnVk2vDgp52hBZkSk/3XfDOuLHeCdZCiGlJTjzM+neH1a+FCfBh6wWdgcnlV9g03y0XT5MNifUinOyasc+1fm2tauSF8nGjfKcon3rq4kPyK6D8NA+GtC4cbsbnu8ax3d+H7PniEKlo8cRWuVf/j16Vrh4WsL/Lur/Ha9/YOosf995C1yvPDPrvMqx javier@Zevenet"
      - username: "javier"
        groups: "javier"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCt5qIWHH3MmfdXEdvAujjWSaSv7UHVE0lYmFEk6S/08Wuv4sQEjteryNjgin2tXXgDwB9OSxfSQqZy/kCE8bSLHS82E5rbdvDw8AYYfXJM+dQXl4EQefmL6IvyMOhR5qFQXiiKR2KUeR5d+y5UV/tXqXHvIK9C/Y5QY/OiPQwOYZiG6PNerMDsTVaQ7ZZINBxQrGLto5U1rFEPfYLJAcA/A+GiB1tv+JJ+B3Mrn5QmxKLcN8iyEUaoJsH6ZlM+lc3o34phYf+pWGyGMrNSNTH3QRUjt8DM79gc7NC1jLEjyXnBCu7oRBKydqMANubs5iRUNFcHHNoUfiQ6VLmaI0F/ javier@Zevenet"
      - username: "javier"
        groups: "javier"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDHchenmsE3uTjX7KowjOnqQqmlY6sVFhkcRlXenEZFlfDSyUHvRES3VkJ1/vRMtZFjlmuQ0OqCGZmQDDHk0RIzdz+9pMYe+zFySvlBZFf2X+eejZB5yTEyabXkOZFnefrPKSsL8a+rlbSoBx42BBSXqgmT+ZQ4aaM2XIz8NM3j4q0wQkAjH8ikaEZ5D1jMmdmtCm6xp1cvIa3LPBfQL0xIVYPqjwlhQL8zrmD3Rj7MLyBCw7ApYkV6tMyUzih2AeO1N4+hf5aW36IWF9fhibar4VEqQdVPP/sutyNL4YhgvSXRmPZnT5UUWt0OJKbTXYjDF0IMi2v/vVf2UMjLhyRd javier@Zevenet"
      - username: "javi"
        groups: "javi"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDptdRbePuyxzKkDM46QwS4L58vv6Bt+FV0Lf891QLVnep2kLeGDlB0ZgZ1wrcxjuTLiUUNnDIL/kOz7/QYVAoE7h6PdEiAqtP6zhypzWiWZKNIICCjq9Ehqmq2PpVOHnnua8Ba9Xg9u2dpY146Eb2ynUvlRWs7HdMeGyPcY2OsaGtylY0FGPRSOsfBv0CDFxN1IJSoWMEuwHsJrZ8G+5Lx38bWWWXlW6/s3ZaXuTk6sFqtuTvuWKidCoakpRll43saUXALYXMbhS0cYd5ohgGgjXVvH+oMrAxA5xQObXgX8DAFIltoP9f4hywyE5GKUtDZnS91SOCkGU9P/XMFHB5/ javi@Zevenet"
      - username: "carm"
        groups: "carm"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCqSXgtkta+ElTmKiirkcftnVrEoBqanAmfdpkBjVMyxDY+5qBGkedggHSfVwDFeNbGZwkdLbA5D4IDAYVqwuDk1Scv7dhpdsp92eR+AqChPP6mkYkq9wFNGcJaqNPPBjRBF+DOQTD/v9p0MM0z4PO41k9XCHo/QPH7bm4UY8xVhlup2CJvsCqbObqTCKJn+w/3t/hJNj2fW9A51WZsAZ3BVzmRqL/luXewVC/tRsmo+Fuf0Z+kU+lIquMubVeMQ1LVgqSLZKrAIOZY7xNONAgl73WFZGlsUuKFWICjSt1xlyDfIyMqTiqLjOENmnu8Igjj4IqswSb57mrbSbL4mwRf carm@Zevenet"
      - username: "carmen"
        groups: "carmen"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDHwdh2h6lJ6UfbpERMWg96ruHmZJf2/27j8CQ5xACMu2h7xyL/JYYa0ZeNzw7YDe4J74Crvqvuf5nlWnbG88coKtwd70dkiyVp4SvyOGQxKZzGIvlpJQxslVobg6QFSMCgRZGnDefkB8BOK6OsV7nvHyqrUyRb0db5cY8uLILWzTmy810rkjQ00cT8vApckjnfr3MRq0kudWuAtBrHOaIkvl7++SoVSPPUuQpoELo5WwKqDX+STfj4K9hYIPeWQ7UA/93gfL1aq/AMU7SeLq3h4cJhNjt2Cth22EoJD3bGtn/fDyjJ1mtmaCWuwGgejTVYZMPUbCUK+N1e7nytN3xH carmen@Zevenet"
      - username: "carmen"
        groups: "carmen"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDeRp6E3vmsM0aUS94KwnnyR76HQK6bFmirEW4/K1GwQGYR5Ozp2SZKlkE9d2qOK5Lglsd/9tcd+K1Yj6Qs/cYm5HGFbDidQuuaM+/UF8j7SIozXNjTF00kxulESUvI0d8BuM4P4V4kutAT0OvXj3n6g/R6naQ35MAlNoo/pXKxHvT6T3du2ue/ZWXL+HUBruZ5nOYySDNeflABvfXymUmjfUw3qn89CEu+oYqNmXO/Bej1zi5N0SWyxamvOuUfoyL+dY6isH1ZD4DILIHk+AIWfPy3XrtSCvGVz1sjV1mnj071PVpcVVAm/mlgIviFqV/rko5q/iR33Lk/BWp7r0k7 carmen@Zevenet"
      - username: "mariano"
        groups: "mariano"
        password: "$6$G.gULXDtEmrwF$xKUgrsr8HfMstO6iQ8Esy6Q5EQaK0JrAyTpg2mmcn5fqwD.8Z.Md4/WjgGG8Yf6iMZBJns66AuqNOCdYc.4h/1"
      - username: "jesus"
        groups: "jesus"
        password: "$6$3brTazJLic6yqJ9T$QJPpL1jGYCpQp1JCYMY4yPhFPcUULqDC8dEOkVYgZdMciZ7zXWVoRjkWqXxNzPFJw0hCq11jGnXDyimMoRbSF/"
    group:
      - group: "mariano"
      - group: "jesus"
  
######################################################################
#Comando para encriptar contraseña mediante consola.
#####apt install whois
##############mkpasswd --method=SHA-512
##############Introducir contraseña y te la cifra. Pegar el chorizo en password=******
#La directiva groups: añade un grupo secundario al usuario. Append lo mete en el grupo aunque el usuario esté creado ya.
  tasks:
##################INSTALACIÓN DE SUDO
  - name: install sudo
    apt: name=sudo update_cache=yes state=latest
#####################CREAR GRUPOS MEDIANTE VARIABLE.###########
######CREA TODOS LOS GRUPOS QUE ESTÁN EN LA VARIABLE GROUP.###################
  - name: create groups 
    group: 
      name: "{{ item.group }}"
    with_items: 
      "{{ group }}"
####################CREA USUARIOS QUE ESTÁN EN LA VARIABLE  USERS CON LOS ATRIBUTOS DE CADA UNO DE LOS USERNAME
#######################VAMOS AÑADIENDO ITEMS POR CADA USUARIO DIFERENTE
#######################REALIZAMOS UN BUCLE QUE VA COGIENDO CADA ATRIBUTO = VALOR QUE HEMOS AÑADIDO
  - name: create users with groups, shell and password.
    user:
      name: "{{ item.username }}"
      group: "{{ item.groups }}"
      password: "{{ item.password }}"
      shell: /bin/bash
      groups: sudo
      append: yes
    with_items:
      "{{ users }}"
############################DIRECTIVAS PARA EL FICHERO ETC/SSH/SSHD_CONFIG
  - name: Disable root login
    lineinfile: dest=/etc/ssh/sshd_config regexp='^PermitRootLogin' line="PermitRootLogin prohibit-password" state=present
  - name: Disable password authentication
    lineinfile: dest=/etc/ssh/sshd_config regexp='^PasswordAuthentication' line="PasswordAuthentication no" state=present
  - name: Enable PAM
    lineinfile: dest=/etc/ssh/sshd_config regexp='^UsePAM' line="UsePAM no" state=present
  - name: Disable challenge response authentication
    lineinfile: dest=/etc/ssh/sshd_config regexp='^ChallengeResponseAuthentication' line="ChallengeResponseAuthentication no" state=present
  - name: Restart SSH service
    service: name=sshd state=restarted
