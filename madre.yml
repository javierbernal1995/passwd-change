---
- hosts: all
############################VARIABLES##################################
  vars:
    users:
      - username: "carmen"
        groups: "carmen"
          publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2LLUuwGzydJFLkX53RK4p/HxESZh8KSRLuZgDWE5gHempVUGwStY45nSWeIl52q118i23CeInHSwMUGvIRqzyvHU+y+BIKkbRZ/nNo3GtT0haxMla44ZX3Vc3JZFAqg0o+LwTxCA96i4H9oDzYKyEtqUJyeavV3tv/CMisudovxGZhRQu3riu66EtPO/1jSBjKnmlYio9Zn6QwEWymk44aPtehVPh5h8eIdO0YXSSj8I1/d3MOlyrE6nKHPl92swwFtiv6uAV9ucqgF1pRH5hXKGt//Y0FSFGtff9aaJ5zkG2+vuhODTKPaEpXS5wOBu0QYo+IG5NIsf9BspSxOkX carmen@Zevenet"
      - username: "pruebaotro"
        groups: "pruebaotro"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCm1Lvi19K+sx1iyBJ8vXGmdHpFRTTcynfvSPvq49s4MNJTiP7GwnPyxkwHLJRVcKzg/wdy/sk/VIKc2yDgnEOTY8oT8LFJZyl0GYbd7BHMDSuY2wMqxwTb8QpNP6kMJsii+/f7Bmr2WrI1GkB5OWG1FmFxHua2NnVAY6YpGaS/DOSMTWtHnUPzfca8aNavP5k39C3LmPD/r9gMnYNYGFUsulMmPTBbVLiwz+oZmBfXtNh6/0gXPF3lab2KrYeTxVSMK5nhaxkb7AQaotauwPsBNnFBnq261ygYUaPuyArM+zKHrIBSjHGJbe5IXaAsN2iyYOpiUn1KZluNr2TMecRp pruebaotro@Zevenet"
      - username: "otro"
        groups: "otro"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQChEHz9mlb0LOPSIp9qTNp5iFQsIFkGvcj18X4RtvbPe8pTBB9kaPXvM3QaPwlSRVq6l5pEz694SQevHuUGsBzziMLYWTbNvwzu41V3mNFpO1lxQH6b7OjBd/vXI1N78XAHUvnD+9+feUMaw2740MleJCKoTsEvoaSgYXShLukwCzA3h2TTwy7OwjQsNYIb4DpbkyNLg6nGO/iUPqgJBhxUSzreopfrAkVli59CwTv3AWNqd0mPMtRCR1mPlxGVZ3gJKrT2N1MQQwx7nSHH3cax4Byw7ly+uXKDP9l83KjF2hIX5wye/m0BJ+npFeomdAzFCIDjFxOeIZOcIcV/4XWr otro@Zevenet"
    grupo:
      - group: "carmen"
      - group: "pruebaotro"
      - group: "otro"

#####################################################################
  tasks:
##################INSTALACIÓN DE SUDO
  - name: install sudo
    apt: name=sudo update_cache=yes state=latest
#####################CREAR GRUPOS MEDIANTE VARIABLE.###########
######CREA TODOS LOS GRUPOS QUE ESTÁN EN LA VARIABLE GROUP.###################
  - name: create groups 
    group: 
      name: "{{ item.group }}"
    with_items: 
      "{{ grupo }}"
####################CREA USUARIOS QUE ESTÁN EN LA VARIABLE  USERS CON LOS ATRIBUTOS DE CADA UNO DE LOS USERNAME
#######################VAMOS AÑADIENDO ITEMS POR CADA USUARIO DIFERENTE
#######################REALIZAMOS UN BUCLE QUE VA COGIENDO CADA ATRIBUTO = VALOR QUE HEMOS AÑADIDO
  - name: create users with groups, shell and password.
    user:
      name: "{{ item.username }}"
      group: "{{ item.groups }}"
      shell: /bin/bash
      groups: sudo
      append: yes
    with_items:
      "{{ users }}"
  - name: authorized_keys
    authorized_key:
      user: "{{ item.username }}"
      state: present
      key: "{{ item.publica }}"
    with_items:
      "{{ users }}"
    
############################DIRECTIVAS PARA EL FICHERO ETC/SSH/SSHD_CONFIG
  - name: Disable root login
    lineinfile: dest=/etc/ssh/sshd_config regexp='^PermitRootLogin' line="PermitRootLogin prohibit-password" state=present
  - name: Disable password authentication
    lineinfile: dest=/etc/ssh/sshd_config regexp='^#PasswordAuthentication' line="PasswordAuthentication no" state=present
  - name: Enable PAM
    lineinfile: dest=/etc/ssh/sshd_config regexp='^UsePAM' line="UsePAM yes" state=present
  - name: Disable challenge response authentication
    lineinfile: dest=/etc/ssh/sshd_config regexp='^ChallengeResponseAuthentication' line="ChallengeResponseAuthentication no" state=present
  - name: Restart SSH service
    service: name=sshd state=restarted
############### Modificar etc profile.d para hacer modo auditoría  
  - name: Mover archivo bashrc al directorio /etc/profile.d/
    copy: src=/root/Script/bashrc.sh dest=/etc/profile.d/ 
######################## Módulo de iptables genéricas, según hostname y según grupo externo e interno
  - name: Ejecutar script en todas las máquinas
    script: /root/principal.sh
    
- hosts: interno
  tasks:
  - name: Ejecutar script en máquinas internas
    script: /root/interno.sh
    
- hosts: externo
  tasks:
  - name: Ejecutar script en máquinas externas
    script: /root/externo.sh
