---
- hosts: all
############################VARIABLES##################################
  vars:
    users:
      - username: "alejandro"
        groups: "alejandro"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDiTRhJxDFD0TtO5v1Cjv1bgYbPo8UmSNMV5/hNUSWuWpAOnMN1teciQETTbxLkF21Sf2Ao9fhhFWGunCLtAjhCMIm+HqbO8MOev8eYxxGVKEwt12w/4NaZAXIH31J+vDEZjz3JIJPbypA19pn6rf1KMVaJTnKf+285oiNhapJE/mjeYQE3plMYkRZ6K5tL4olFSTQ3i+riyLpQxKWW4Gnm4qGifLNvJ+7GOLx12WhcaQ5jtAs2z1KWULK0FXGUthWhjBlplvnzqMabIgf1XpNty6ro0E4TuREJJ0aXGAYniGf4XNiKVeN9Ay4Dq7NOFcDskyrCKMUEaJtwRAelqK77 alejandro@Servidor"
      - username: "mario"
        groups: "mario"
        publica: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7lSoKqb/oW5/vcZ0fZj+njPyfBqwx21BhfzsdbVUk7M8SiDWvxz4So/EJ+su2kUhvt0EoN14c1GvzF8yW5R2PbGP1CCflh0NU8RfV+jLPUvuA2DgD03ujDvdnJY9tUIgVtq203mBuLPHtEU4lzng2gPVOcVak4f3BBWYJXzSSC0DdLli4iyiL3JelO4/Fh6zo/WonWkJoctp0xtCIikQyduolOiW6QwFOmf+wYKcNTVbD2Je8bgx1TjZnN9k11HhknGo11J8DXEJa1B6bZM2ZPfUYgKqYi8uVRMdhqZGk1U27dbzrkPB34djjVzc1qHG6AAphxxVi/bEJD1mGpprH mario@Servidor"
    grupo:
      - group: "alejandro"
      - group: "mario"

  
#####################################################################
  tasks:
##################INSTALACIÓN DE SUDO
  - name: install sudo
    apt: name=sudo update_cache=yes state=latest
#####################CREAR GRUPOS MEDIANTE VARIABLE.###########
######CREA TODOS LOS GRUPOS QUE ESTÁN EN LA VARIABLE GROUP.###################
  - name: create groups 
    group: 
      name: "{{ item.group }}"
    with_items: 
      "{{ grupo }}"
####################CREA USUARIOS QUE ESTÁN EN LA VARIABLE  USERS CON LOS ATRIBUTOS DE CADA UNO DE LOS USERNAME
#######################VAMOS AÑADIENDO ITEMS POR CADA USUARIO DIFERENTE
#######################REALIZAMOS UN BUCLE QUE VA COGIENDO CADA ATRIBUTO = VALOR QUE HEMOS AÑADIDO
  - name: create users with groups, shell and password.
    user:
      name: "{{ item.username }}"
      group: "{{ item.groups }}"
      shell: /bin/bash
      groups: sudo
      append: yes
    with_items:
      "{{ users }}"
  - name: create directory .ssh
    file: 
        path: /home/{{ item.username }}/.ssh 
        state: directory
    with_items:
      "{{ users }}"
  - name: create empty file authorized_keys
    file:
        path: /home/{{ item.username }}/.ssh/authorized_keys 
        state: touch
    with_items:
      "{{ users }}"
  - name: send public key
    lineinfile: 
        path: /home/{{ item.username }}/.ssh/authorized_keys 
        line: "{{ item.publica }}"
        state: present
    with_items:
      "{{ users }}"
    
############################DIRECTIVAS PARA EL FICHERO ETC/SSH/SSHD_CONFIG
  - name: Disable root login
    lineinfile: dest=/etc/ssh/sshd_config regexp='^PermitRootLogin' line="PermitRootLogin prohibit-password" state=present
  - name: Disable password authentication
    lineinfile: dest=/etc/ssh/sshd_config regexp='^#PasswordAuthentication' line="PasswordAuthentication no" state=present
  - name: Enable PAM
    lineinfile: dest=/etc/ssh/sshd_config regexp='^UsePAM' line="UsePAM no" state=present
  - name: Disable challenge response authentication
    lineinfile: dest=/etc/ssh/sshd_config regexp='^ChallengeResponseAuthentication' line="ChallengeResponseAuthentication no" state=present
  - name: Restart SSH service
    service: name=sshd state=restarted
############### Modificar etc profile.d para hacer modo auditoría  
  - name: Mover archivo bashrc al directorio /etc/profile.d/
    copy: src=/root/Script/bashrc.sh dest=/etc/profile.d/ 
######################## Módulo de iptables genéricas, según hostname y según grupo externo e interno
  - name: Ejecutar script en todas las máquinas
    script: /root/principal.sh
    
- hosts: interno
  tasks:
  - name: Ejecutar script en máquinas internas
    script: /root/interno.sh
    
- hosts: externo
  tasks:
  - name: Ejecutar script en máquinas externas
    script: /root/externo.sh
